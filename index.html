<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>PolyForest</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.12.1/semantic.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.12.1/semantic.css">
	<link rel="stylesheet" href="main.css">
	<script id="vertex-shaderH" type="x-shader/x-vertex">
		#define MAX_LIGHTS 10
		precision mediump float;
		attribute vec3 vPosition;
		attribute vec3 normal;
		attribute vec2 vTexCoord;
		varying vec3 N, L[MAX_LIGHTS], E;
		varying vec3 pos;
		uniform vec4 lightPosition[MAX_LIGHTS];
		uniform mat4 projection;
		uniform mat4 modelView;
		uniform mat3 normalMatrix;
		uniform sampler2D hTexture;
		uniform sampler2D nTexture;
		uniform int enableTex;
		uniform mat4 texTransform;
		void main() {
			vec4 temp = texTransform * vec4(vTexCoord[0], 0.0, vTexCoord[1], 1.0);
			vec2 vTexCoordTransform = vec2(temp[0], temp[2]);
			vec4 hSample = texture2D(hTexture, vTexCoordTransform);
			float z;
			for (int i = 0; i < 3; i++) {
				z += hSample[i] * hSample[i];
			}
			z = sqrt(z) * 3.0;
			vec4 nSample = texture2D(nTexture, vTexCoordTransform);

			if (enableTex == 0) {
				gl_Position = projection * modelView * vec4(vPosition, 1.);
			} else {
				gl_Position = projection * modelView * vec4(vPosition[0], z, vPosition[2], 1.);
			}

			pos = (modelView * vec4(vPosition, 1.)).xyz;
			E = -normalize(pos);
			if (enableTex == 0) {
				N = normalize(normalMatrix * normal);
			} else {
				// N = normalize(normalMatrix * nSample.xyz);
				N = normalize(normalMatrix * vec3(0, 0, 1));
			}
			for (int i = 0; i < MAX_LIGHTS; i ++) {
				if (lightPosition[i].z == 0.0)
					L[i] = normalize(lightPosition[i].xyz);
				else
					L[i] = normalize(lightPosition[i].xyz - pos);
			}
		}
	</script>
	<script id="fragment-shaderH" type="x-shader/x-fragment">
		#define MAX_LIGHTS 10
		precision mediump float;
		uniform float shininess;
		uniform vec4 ambientProduct[MAX_LIGHTS];
		uniform vec4 diffuseProduct[MAX_LIGHTS];
		uniform vec4 specularProduct[MAX_LIGHTS];
		varying vec3 N, L[MAX_LIGHTS], E;
		varying vec3 pos;
		uniform vec4 lightPosition[MAX_LIGHTS];
		uniform int lightNum;
		void main()
		{
			vec4 fColor = vec4(0.0, 0.0, 0.0, 0.0);
			for (int i = 0; i < MAX_LIGHTS; i ++) {
				if (i > lightNum)
					break;

				vec3 H = normalize(L[i] + E);

				float Kd = max(dot(L[i], N), 0.0);
				vec4 diffuse = Kd * diffuseProduct[i];

				float Ks = pow(max(dot(N, H), 0.0), shininess);
				vec4 specular = Ks * specularProduct[i];
				
				if (dot(L[i], N) < 0.0)
					specular = vec4(0.0, 0.0, 0.0, 1.0);

				float len = length(pos - lightPosition[i].xyz);

				float d = 0.00009 * len * len + 0.05 * len;
				
				fColor += (ambientProduct[i] + diffuse + specular) / d;
			}

			fColor.a = 1.0;
			gl_FragColor = fColor;
		}
	</script>
	<script id="vertex-shaderL" type="x-shader/x-vertex">
		#define MAX_LIGHTS 5
		precision mediump float;
		attribute vec3 vPosition;
		attribute vec3 normal;
		varying vec3 N, L[MAX_LIGHTS], E;
		varying vec3 pos;
		uniform vec4 lightPosition[MAX_LIGHTS];
		uniform mat4 projection;
		uniform mat4 modelView;
		uniform mat3 normalMatrix;
		void main() {
			gl_Position = projection * modelView * vec4(vPosition, 1.);

			pos = (modelView * vec4(vPosition, 1.)).xyz;
			E = -normalize(pos);
			N = normalize(normalMatrix * normal);
			for (int i = 0; i < MAX_LIGHTS; i ++) {
				if (lightPosition[i].z == 0.0)
					L[i] = normalize(lightPosition[i].xyz);
				else
					L[i] = normalize(lightPosition[i].xyz - pos);
			}
		}
	</script>
	<script id="fragment-shaderL" type="x-shader/x-fragment">
		#define MAX_LIGHTS 5
		precision mediump float;
		uniform float shininess;
		uniform vec4 ambientProduct[MAX_LIGHTS];
		uniform vec4 diffuseProduct[MAX_LIGHTS];
		uniform vec4 specularProduct[MAX_LIGHTS];
		varying vec3 N, L[MAX_LIGHTS], E;
		varying vec3 pos;
		uniform vec4 lightPosition[MAX_LIGHTS];
		uniform int lightNum;
		void main()
		{
			vec4 fColor = vec4(0.0, 0.0, 0.0, 0.0);
			for (int i = 0; i < MAX_LIGHTS; i ++) {
				if (i > lightNum)
					break;

				vec3 H = normalize(L[i] + E);

				float Kd = max(dot(L[i], N), 0.0);
				vec4 diffuse = Kd * diffuseProduct[i];

				float Ks = pow(max(dot(N, H), 0.0), shininess);
				vec4 specular = Ks * specularProduct[i];
				
				if (dot(L[i], N) < 0.0)
					specular = vec4(0.0, 0.0, 0.0, 1.0);

				float len = length(pos - lightPosition[i].xyz);

				float d = 0.00009 * len * len + 0.05 * len;
				
				fColor += (ambientProduct[i] + diffuse + specular) / d;
			}

			fColor.a = 1.0;
			gl_FragColor = fColor;
		}
	</script>
	<script type="text/javascript" src="randomcolor.js"></script>

	<script type="text/javascript" src="webgl-utils.js"></script>
	<script type="text/javascript" src="initShaders.js"></script>
	<script type="text/javascript" src="MV.js"></script>
	<script type="text/javascript" src="particals.js"></script>
	<script type="text/javascript" src="project.js"></script>
</head>
<body>
	<div class="ui grid">
		<div class="column">
			<canvas id="gl-canvas" width="1024" height="576"></canvas>	
		</div>
		<div class="right floated left aligned four wide column" id="options-column">
			<div class="ui vertical menu">
				<div class="item">
					<h1 id="title">Poly Forest</h1>
				</div>
				<div class="item">
					<div class="ui primary button" onclick="startGL()">Start</div>
				</div>
				<div class="item">
					Here's the description of the project.
				</div>
				<div class="header item">Select music</div>
				<div class="active item bgm" onclick="setBGM($(this))" bgm-id="kida">Kid A</div>
				<div class="item bgm" onclick="setBGM($(this))" bgm-id="soma">Some other song</div>
				<div class="item bgm" bgm-id="custom">
					<div class="ui icon input">
						<input id="bgm-input" type="file">
						<i class="upload icon"></i>
					</div>
				</div>
				<div class="header item">Select color theme</div>
				<div class="active item color"  onclick="setColor($(this))" color-id="bright">Bright</div>
				<div class="item color"  onclick="setColor($(this))" color-id="light">Light</div>
				<div class="item color"  onclick="setColor($(this))" color-id="dark">Dark</div>
				<div class="header item">Effects</div>
				<div class="active item effects"  onclick="setEffects($(this))" effects-id="high">High</div>
				<div class="item effects"  onclick="setEffects($(this))" effects-id="low">Low (for iPhone)</div>
				<div class="header item">For Spring 15 CS 174A.</div>
			</div>
		</div>
	</div>
	<div id="audio-zone">
		<audio id="kida" src="Kid_A.mp3"></audio>
	</div>
</body>
</html>
