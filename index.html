<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Team18-Term-Project</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.12.1/semantic.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.12.1/semantic.css">
	<link rel="stylesheet" href="main.css">
	<script id="vertex-shader" type="x-shader/x-vertex">
		#define MAX_LIGHTS 10
		precision mediump float;
		attribute vec3 vPosition;
		attribute vec3 normal;
		varying vec3 N, L[MAX_LIGHTS], E;
		varying float d[MAX_LIGHTS];
		uniform int lightNum;
		uniform vec4 lightPosition[MAX_LIGHTS];
		uniform mat4 projection;
		uniform mat4 modelView;
		uniform mat3 normalMatrix;
		void main() {
			gl_Position = projection * modelView * vec4(vPosition, 1.);

			vec3 pos = (modelView * vec4(vPosition, 1.)).xyz;
			E = -normalize(pos);
			N = normalize(normalMatrix * normal);
			for (int i = 0; i < MAX_LIGHTS; i ++) {
				if (lightPosition[i].z == 0.0)
					L[i] = normalize(lightPosition[i].xyz);
				else
					L[i] = normalize(lightPosition[i]).xyz - pos;

				if (i > lightNum)
					d[i] = 1.0 / 0.0; // Inf
				else {
					float len = length(modelView * vec4(vPosition, 1.) - lightPosition[i]);
					d[i] = 0.0005 * len * len + 0.001 * len;
				}
			}
		}
	</script>
	<script id="fragment-shader" type="x-shader/x-fragment">
		#define MAX_LIGHTS 10
		precision mediump float;
		uniform float shininess;
		uniform vec4 ambientProduct[MAX_LIGHTS];
		uniform vec4 diffuseProduct[MAX_LIGHTS];
		uniform vec4 specularProduct[MAX_LIGHTS];
		varying vec3 N, L[MAX_LIGHTS], E;
		varying float d[MAX_LIGHTS];
		
		void main()
		{
			vec4 fColor = vec4(0.0, 0.0, 0.0, 0.0);
			for (int i = 0; i < MAX_LIGHTS; i ++) {
				vec3 H = normalize(L[i] + E);

				float Kd = max(dot(L[i], N), 0.0);
				vec4 diffuse = Kd * diffuseProduct[i];

				float Ks = pow(max(dot(N, H), 0.0), shininess);
				vec4 specular = Ks * specularProduct[i];
				
				if (dot(L[i], N) < 0.0)
					specular = vec4(0.0, 0.0, 0.0, 1.0);

				fColor += (ambientProduct[i] + diffuse + specular) / d[i];
			}

			fColor.a = 1.0;
			gl_FragColor = fColor;
		}
	</script>
	<script type="text/javascript" src="webgl-utils.js"></script>
	<script type="text/javascript" src="initShaders.js"></script>
	<script type="text/javascript" src="MV.js"></script>
	<script type="text/javascript" src="particals.js"></script>
	<script type="text/javascript" src="project.js"></script>
</head>
<body>
	<div class="ui grid">
		<div class="column">
			<canvas id="gl-canvas" width="1024" height="576"></canvas>	
		</div>
		<div class="right floated left aligned four wide column" id="bgm-column">
			<div class="ui primary button" onclick="startGL()">Start</div>
			<div class="ui inverted secondary pointing bgm menu">
				<div class="active item" onclick="setBGM(this)" bgm-id="kida">Kid A</div>
				<div class="item" onclick="setBGM(this)" bgm-id="soma">Some other song</div>
			</div>
			<input id="bgm-input" type="file">
		</div>
	</div>
	<div id="audio-zone">
		<audio id="kida" src="Kid_A.mp3"></audio>
	</div>
</body>
</html>
